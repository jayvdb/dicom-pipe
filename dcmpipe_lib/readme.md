# dcmpipe_lib #

This crate is the core DICOM reading/writing library. This crate is focused only on basic
reading/writing of DICOM datasets and should have few dependencies. It does not depend on the DICOM
standard dictionary, instead able to parse through most dicom based only on knowing a minimal set of
DICOM constants.

### Standard DICOM Dictionary ###

The standard DICOM dictionary is an optional feature of this crate. The reading and writing
functionality is not dependent on the standard dictionary, however for parsing element values the
dictionary can be used for Implicit VR encodings.

The standard dictionary can be included using the feature `stddicom`.

The build script in the `build` folder generates the standard DICOM dictionary.

Files generated by the build script:
- `src/dict/lookup.rs`
- `src/dict/tags.rs`
- `src/dict/transfer_syntaxes.rs`
- `src/dict/uids.rs`

### Example ###

Using the parser to loop over elements as they are read from the DICOM dataset stream
```rust
let mut parser: Parser<'_, File> = ParserBuilder::default()
    .dictionary(&STANDARD_DICOM_DICTIONARY)
    // PixelData is 0x7FE0_0010, could also use tags::PixelData.tag.into()
    .stop(TagStop::BeforeTagValue(tags::PixelData.tag.into()))
    .build(file);

for element_res in parser {
    let element: DicomElement = element_res?;
    let value: RawValue = element.parse_value()?;
}
```

Reading the DICOM dataset into `DicomObject` and pulling an element by `TagPath`
```rust
let mut parser: Parser<'_, File> = ParserBuilder::default()
    .dictionary(&STANDARD_DICOM_DICTIONARY)
    .stop(TagStop::BeforeTagValue(tags::PixelData.tag.into()))
    .build(file);

// Parsing into object returns Result<Option<DicomObject>>.
// If the dataset isn't actually dicom it returns Ok(None) rather than error.
let dcmroot: DicomRoot = DicomRoot::parse(parser)??;

// Builds a path for
//    ReferencedFrameOfReferenceSequence[1]
//      .RTReferencedStudySequence[1]
//        .RTReferencedSeriesSequence[1]
//          .ContourImageSequence[11]
//            .ReferencedSOPInstanceUID
//
// There are convenience implementations of `From` of common types into `TagNode` as well as into
// `TagPath`. The `From` implementations for `TagPath` require all elements of `Vec`/slice be the
// same type. Since not all item indexes are `1`, this uses `.into()` to create a `Vec<TagNode>`
// which is then converted to a `TagPath` with another `.into()`.
let tagpath: TagPath = vec![
        (&tags::ReferencedFrameofReferenceSequence).into(),
        (&tags::RTReferencedStudySequence).into(),
        (&tags::RTReferencedSeriesSequence).into(),
        TagNode::from((&tags::ContourImageSequence, Some(11))),
        (&tags::ReferencedSOPInstanceUID).into(),
    ]
    .into();

// If all desired indexes are `1` then this can be slightly simplified:
let tagpath: TagPath = vec![
        &tags::ReferencedFrameofReferenceSequence,
        &tags::RTReferencedStudySequence,
        &tags::RTReferencedSeriesSequence,
        &tags::ContourImageSequence,
        &tags::ReferencedSOPInstanceUID,
    ]
    .into();

// Get the value by tagpath, parse the element value from its raw bytes.
let ref_sopuid: RawValue = dcmroot
    .get_child_by_tagpath(tagpath)?
    .get_element()
    .parse_value()?;

if let RawValue::Uid(uid) = ref_sopuid {
    println!("Referenced SOP Instance UID: {}", uid);
}
```

### Tests ###

Test fixtures are files used by some tests. Due to the large size of these test datasets they are not included in the repository. To set up these test fixtures:
1. [Download the fixutres (700mb .7z)](https://drive.google.com/file/d/1VI89r3leiLPm9-8sClyy0o15KtGZeqaD/view?usp=sharing).
2. Extract the downloaded archive into this directory.
3. The resulting extraction should create a `dcmpipe_lib/fixtures` folder with subfolders containing the test datasets.
c
---

_These fixtures are a suite of dicom files gathered from several sources:_
 - [gdcm](http://gdcm.sourceforge.net/), notably
   - [gdcmData](https://sourceforge.net/projects/gdcm/files/gdcmData/)
   - [gdcmConformanceTests](https://sourceforge.net/projects/gdcm/files/gdcmConformanceTests/)
 - [David Clunie](https://www.dclunie.com/), at the bottom of the page under `Images`
